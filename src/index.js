import { Color,Scene, GridHelper, HemisphereLight, DirectionalLight, Mesh, BoxGeometry, CylinderGeometry, Object3D, PerspectiveCamera, WebGLRenderer, Shape,
    ReinhardToneMapping, PCFSoftShadowMap, MeshPhongMaterial, SphereGeometry,sRGBEncoding,CameraHelper,
    Vector2, MeshPhysicalMaterial, ExtrudeGeometry, MeshStandardMaterial,ACESFilmicToneMapping,
    DirectionalLightHelper, PointLight, MeshBasicMaterial, AmbientLight, OrthographicCamera, Math as threeMath,
 } from 'https://cdn.skypack.dev/three@0.137';
import TWEEN from 'https://cdn.skypack.dev/@tweenjs/tween.js';

// global variable
let scene;
let camera;
let alphabet;
let isBeatting;

class Random {
    constructor() {
        this.useA = false;
        let sfc32 = function (uint128Hex) {
            let a = parseInt(uint128Hex.substr(0, 8), 16);
            let b = parseInt(uint128Hex.substr(8, 8), 16);
            let c = parseInt(uint128Hex.substr(16, 8), 16);
            let d = parseInt(uint128Hex.substr(24, 8), 16);
            return function () {
            a |= 0; b |= 0; c |= 0; d |= 0;
            let t = (((a + b) | 0) + d) | 0;
            d = (d + 1) | 0;
            a = b ^ (b >>> 9);
            b = (c + (c << 3)) | 0;
            c = (c << 21) | (c >>> 11);
            c = (c + t) | 0;
            return (t >>> 0) / 4294967296;
            };
        };
        // seed prngA with first half of tokenData.hash
        this.prngA = new sfc32(tokenData.hash.substr(2, 32));
        // seed prngB with second half of tokenData.hash
        this.prngB = new sfc32(tokenData.hash.substr(34, 32));
        for (let i = 0; i < 1e6; i += 2) {
            this.prngA();
            this.prngB();
        }
    }
    // random number between 0 (inclusive) and 1 (exclusive)
    random_dec() {
        this.useA = !this.useA;
        return this.useA ? this.prngA() : this.prngB();
    }
    // random number between a (inclusive) and b (exclusive)
    random_num(a, b) {
        return a + (b - a) * this.random_dec();
    }
    // random integer between a (inclusive) and b (inclusive)
    // requires a < b for proper probability distribution
    random_int(a, b) {
        return Math.floor(this.random_num(a, b + 1));
    }
    // random boolean with p as percent liklihood of true
    random_bool(p) {
        return this.random_dec() < p;
    }
    // random value in an array of items
    random_choice(list) {
        return list[this.random_int(0, list.length - 1)];
    }
  }

let renderer;
let list = [];
let tokenData = genTokenData(123);
let r = new Random();



class Alphabet{
    ID = 1;
    DOT_SIZE = 10;
    NO_OF_NODE = 7;

    X_START_POS = -(this.NO_OF_NODE / 2) * this.DOT_SIZE;
    Y_START_POS = -(this.NO_OF_NODE / 2) * this.DOT_SIZE;
    Z_START_POS = -4.5 * this.DOT_SIZE;

    group;
    dataSet;

    constructor(){
        this.group = new Object3D();
        var meshArray = [];
        this.dataSet = [];
        var geometry = this.genGeometry();
        this.genData();
        for (var j = 0; j < this.dataSet.length; j++) {

            for (var i = 0; i < this.dataSet[j].length; i++) {

                var x = (i % this.NO_OF_NODE) * this.DOT_SIZE/2 + this.X_START_POS;
                var y = (this.NO_OF_NODE - Math.floor(i / this.NO_OF_NODE)) * this.DOT_SIZE/2 + this.Y_START_POS;
                var z = j * this.DOT_SIZE/2 + this.Z_START_POS;

                if (this.dataSet[j][i] != "0"){
                    var material = new MeshPhongMaterial({
                        transparent: 1,
                        opacity: 0.6,
                        alphaTest: 0,
                        color: new Color(this.getRgbColor(this.dataSet[j][i])),
                        specular: new Color("#483c3c"),
                        shininess: 100
                    });

                    meshArray[i] = new Mesh(geometry, material);
                    meshArray[i].position.x = x;
                    meshArray[i].position.y = y;
                    meshArray[i].position.z = 0;
                    this.group.add(meshArray[i]);
                    list.push(meshArray[i]);
                }

            }
        }


        for (var i = 0; i < list.length; i++) {
            new TWEEN.Tween(list[i].scale).to({ x: 1, y: 1, z: 1 }, 1000).easing(TWEEN.Easing.Back.Out).start();
        }
    }

    genGeometry() {
        let random_sharp = Math.random() * 10 % 3 | 0;
        let random_size = Math.random() * 10 + 5 | 0;
        random_sharp = 1;
        random_size = 5;
        if (random_sharp == 0)
            return new SphereGeometry(random_size/2);
        else if (random_sharp == 1)
            return new BoxGeometry(random_size,random_size,random_size);
        else if (random_sharp == 2)
            return new CylinderGeometry(5,5,5,5,6, false);
        else if (random_sharp == 3) {
            var sharp = new SphereGeometry(random_size/2);
            sharp.transal
        }
        else {
            const extrudeSettings2 = {
                steps: 200,
                depth: 0.2,
                bevelEnabled: true,
                bevelThickness: 1,
                bevelSize: 1,
                bevelOffset: 0.2,
                bevelSegments: 25
            };

            const pts2 = [], numPts = 5;

            for ( let i = 0; i < numPts * 2; i ++ ) {
                const l = i % 2 == 1 ? this.DOT_SIZE : this.DOT_SIZE/2;
                const a = i / numPts * Math.PI;

                pts2.push( new Vector2( Math.cos( a ) * l, Math.sin( a ) * l ) );
            }

            const shape2 = new Shape( pts2 );

            return new ExtrudeGeometry( shape2, extrudeSettings2 );
        }
    }

    hex2bin(hex){
        return (parseInt(hex, 16).toString(2)).padStart(49, '0');
    }

    getAlphabet(){

        var encodedLetter = {
            "A": "FBFE3C7FF1E3",
            "B": "51E227889E14",
            "C": "FB0E0C1830BE",
            "D": "1F3161C3870FE",
            "E": "1FF060F98307F",
            "F": "1FF060F183060",
            "G": "FB1E1C19F13E",
            "H": "1870E1FF870E1",
            "I": "F84081021F3E",
            "J": "FA284089121C",
            "K": "18B268E1A3262",
            "L": "1FF7EFDFBF1FF",
            "M": "11DD631",
            "N": "96AD29",
            "O": "64A526",
            "P": "E4B908",
            "Q": "64A567",
            "R": "E4B929",
            "S": "C8305C",
            "T": "E21084",
            "U": "94A526",
            "V": "94A4C2",
            "W": "118C6AA",
            "X": "A5114A",
            "Y": "A51084",
            "Z": "F1110F",
        }

        //var data =[Array.from(this.hex2bin(encodedLetter[r.random_choice(["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"])]))];
        var data =[Array.from(this.hex2bin(encodedLetter["B"]))];
        var i = 0;
        for (i = 0; i < this.NO_OF_NODE; i++){
            data.push(data[0]);
        }

        return data;
    }

    genData() {
        var brick = []
        brick = [ "WH", "BG", "BR", "RD", "YL", "GN", "WT", "BL", "PR"];
        brick = [ "MP", "LI", "PPB", "PA", "PS", "PP", "BT", "DM","CO"];
        brick = [ "GG", "FF", "CL", "BA", "PR", "AT", "TC", "DT", "PO"];
        brick = ["A0", "A1", "A2", "A3", "A4", "A5", "A6"]

        this.dataSet =  this.getAlphabet();//new Array();

        var brickColor = brick[Math.floor(r.random_dec() * brick.length)];
        var x = 0;
        for (var j = 0; j < this.dataSet.length; j++) {
            for (var i = 0; i < this.dataSet[j].length; i++){
                if (this.dataSet[j][i] != "0"){
                    this.dataSet[j][i] = "MP";         
                }
                
                if ((i+1) % 7 == 0)
                {
                    x++;
                    if (x>6)
                        x= 0;
                }
            }

        }

        return this.dataSet;
    }

    getRgbColor(colorType) {
        var colorHash = {
            "WH":"#FFFFFF", // white
            "BG":"#edcda6", // beige
            "BR":"#800000", // brown
            "RD":"#FF0000", // red
            "YL":"#FFFF00", // yellow
            "GN":"#00FF00", // green
            "WT":"#00FFFF", // water
            "BL":"#0000FF", // blue
            "PR":"#800080",  // purple

            // Light Multiple
            "MP":"#986DE8", // Matt Purple
            "LI":"#B2F477", // Lima
            "PPB":"#CCD6FF", // Pale Phthalo Blue
            "PA":"#FCFFAD", // Parchment
            "PS":"#bd69ea", // Purple Snail
            "PP":"#e3a6f4", // Petal Plush
            "BT":"#ffc77f", // Beige Topaz
            "DM":"#88f7f5", // Defense Matrix
            "CO":"#a194f7", // Cobalite

            // Dark Multiple
            "GG":"#e8cb12", // Gouda Gold
            "FF":"#ed099d", // Fanatic Fuchsia
            "CL":"#001d59", // Clarinet
            "BA":"#b111c6", // Barney
            "PR":"#1a0b7f", // Prunelle
            "AT":"#068960", // Absinthe Turquoise
            "TC":"#0f7c01", // Toy Camouflage
            "DT":"#025a5b", // Dark Turquoise
            "PO":"#077c19", // Poblano,

            "A0": "#005e28",
            "A1": "#00565f",
            "A2": "#00466a",
            "A3": "#35477e",
            "A4": "#4f4482",
            "A5": "#b54788",
            "A6": "#fb5f5f",
        };
        return colorHash[colorType];
    }

    changeFormation1() {
        for (var i = 0; i < list.length; i++) {
            var rot = 360 / list.length * i;
            var vx = Math.random() * 300 - 200;
            var vy = Math.random() * 300 - 200;
            var vz = Math.random() * 300 - 200;
            
            new TWEEN.Tween(list[i].position).to({ x: vx, y: vy, z: vz }, 1000).easing(TWEEN.Easing.Exponential.Out).start();
            new TWEEN.Tween(list[i].rotation).to({ x: 0, y: rot, z: 0 }, 1000).easing(TWEEN.Easing.Cubic.InOut).start();
        }
    }

    //Cube
    changeFormation2() {
        isBeatting = false;
        for ( let i = 0, l = list.length; i < l; i ++ ) {
            const object = list[ i ];
            object.scale.set( 1, 1, 1 );
        }
        
        var k = 0;
        for (var j = 0; j < this.dataSet.length; j++) {
            for (var i = 0; i < this.dataSet[j].length; i++) {
                var x = (i % this.NO_OF_NODE) * this.DOT_SIZE/2 + this.X_START_POS;
                var y = (this.NO_OF_NODE - Math.floor(i / this.NO_OF_NODE)) * this.DOT_SIZE/2 + this.Y_START_POS;
                var z = j * this.DOT_SIZE/2 + this.Z_START_POS;

                if (this.dataSet[j][i] != "0"){
                    var orgColor = new Color(this.getRgbColor(this.dataSet[j][i]));
                    new TWEEN.Tween(list[k].material.color).to({r:orgColor.r, g:orgColor.g, b:orgColor.b}, 1000).easing(TWEEN.Easing.Cubic.InOut).start();
                    new TWEEN.Tween(list[k].position).to({ x: x, y: y, z: 0 }, 1000).easing(TWEEN.Easing.Exponential.InOut).start();
                    new TWEEN.Tween(list[k].rotation).to({ x: 0, y: 0, z: 0 }, 1000).easing(TWEEN.Easing.Cubic.InOut).start();
                    k++;
                }
            }
        }
    }

    changeFormation3() {
        for (var i = 0; i < list.length; i++) {
            var rot = 360 / list.length * i;
            var vx = Math.random() * 400 - list.length/2;
            var vy = -10;
            var vz = Math.random() * 400 - list.length/2;

            new TWEEN.Tween(list[i].position).to({ x: vx, y: vy, z: vz }, 1000).easing(TWEEN.Easing.Exponential.InOut).start();
            new TWEEN.Tween(list[i].rotation).to({ x: 0, y: rot, z: 0 }, 1000).easing(TWEEN.Easing.Cubic.InOut).start();
        }
    }

    changeFormation4() {
        for (var i = 0; i < list.length; i++) {
            var rot = 25 * i;
            var vx = 150 * Math.sin(rot * Math.PI / 180);
            var vy = 1 * i - 10;
            var vz = 150 * Math.cos(rot * Math.PI / 180);

            new TWEEN.Tween(list[i].position).to({ x: vx, y: vy, z: vz }, 1000).easing(TWEEN.Easing.Exponential.InOut).start();
            new TWEEN.Tween(list[i].rotation).to({ x: 0, y: rot, z: 0 }, 1000).easing(TWEEN.Easing.Cubic.InOut).start();
        }
    }

    changeFormation5() {
        for (var i = 0; i < list.length; i++) {
            var rot = 25 * i;
            var vx = i * Math.sin(rot * Math.PI / 180) / 5;
            var vy = i;
            var vz = i * Math.cos(rot * Math.PI / 180) / 5;

            new TWEEN.Tween(list[i].position).to({ x: vx, y: vy, z: vz }, 1000).easing(TWEEN.Easing.Exponential.InOut).start();
            new TWEEN.Tween(list[i].rotation).to({ x: 0, y: rot, z: 0 }, 1000).easing(TWEEN.Easing.Cubic.InOut).start();
        }
    }

    changeFormation6() {
        let random_size = Math.random() * 10 + 5 | 0;
        for (var i = 0; i < list.length; i++) {
            var rot = 25 * i;
            var vx = i * Math.sin(rot * Math.PI / 180) - 30;
            var vy = i - 90;
            var vz = i * Math.cos(rot * Math.PI / 180) - 20;
            var newColor = new Color(this.getRgbColor(r.random_choice(["A0", "A1", "A2", "A3", "A4","A5", "A6"])));
            new TWEEN.Tween(list[i].material.color).to({r:newColor.r, g:newColor.g, b:newColor.b}, 1000).easing(TWEEN.Easing.Cubic.InOut).start();
            new TWEEN.Tween(list[i].position).to({ x: vx, y: vy, z: vz }, 1000).easing(TWEEN.Easing.Exponential.InOut).start();
            new TWEEN.Tween(list[i].rotation).to({ x: 0, y: rot, z: 0 }, 1000).easing(TWEEN.Easing.Cubic.InOut).start();
        }
    }

    changeFormation7() {
        for (var i = 0; i < list.length; i++) {
            var rot = 25 * i;
            var vx = 150 * Math.sin(rot * Math.PI / 180);
            var vy = (i - 1) * 10;
            var vz = 150 * Math.cos(rot * Math.PI / 180);

            new TWEEN.Tween(list[i].position).to({ x: vx, y: vy, z: vz }, 1000).easing(TWEEN.Easing.Exponential.InOut).start();
            new TWEEN.Tween(list[i].rotation).to({ x: 0, y: rot, z: 0 }, 1000).easing(TWEEN.Easing.Cubic.InOut).start();
        }
    }

    changeFormation8() {
        for (var i = 0; i < list.length; i++) {
            var rot = 25 * i;
            if (i < list.length / 2) {
                var vx = 50 * Math.cos(rot * Math.PI / 360);
                var vy = i * 5 - list.length;
                var vz = 50 * Math.sin(rot * Math.PI / 360);
            } else {
                var vx = 50 * Math.sin(rot * Math.PI / 180);
                var vy = (i - list.length / 2) * 5 - list.length;
                var vz = 50 * Math.cos(rot * Math.PI / 180);
            }

            new TWEEN.Tween(list[i].position).to({ x: vx, y: vy, z: vz }, 1000).easing(TWEEN.Easing.Cubic.InOut).start();
            new TWEEN.Tween(list[i].rotation).to({ x: 0, y: rot, z: rot }, 1000).easing(TWEEN.Easing.Cubic.InOut).start();
        }
    }

    update() {
        isBeatting = true;
        switch (this.ID) {
            case 1:
                this.changeFormation1();
                break;
            case 2:
                this.changeFormation2();
                break;
            case 3:
                this.changeFormation3();
                break;
            // case 4:
            //     this.changeFormation4();
            //     break;
            // case 5:
            //     this.changeFormation5();
            //     break;
            // case 6:
            //     this.changeFormation6();
            //     break;
            // case 7:
            //     this.changeFormation7();
            //     break;
            default:
                this.changeFormation7();
        }

        this.ID++;
        if (this.ID > 4) {
            this.ID = 1;
        }
    }

    deploy()
    {
        return this.group;
    }
}



init();

function init(){
    scene = new Scene();
    scene.background = new Color( 0xf0f0f0  );

    // const helper = new GridHelper( 2000, 100 );
    // helper.position.y = - 199;
    // scene.add( helper );

    camera = new PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 10000 );
    camera.position.set( -20, -10, 100 );
        
    renderer = new WebGLRenderer({ antialias: true });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(innerWidth, innerHeight);
    renderer.toneMapping = sRGBEncoding;
    renderer.physicallyCorrectLights = true;
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = PCFSoftShadowMap;
    document.body.appendChild(renderer.domElement);


    const light = new DirectionalLight( 0xffffff, 9 );
    light.position.set( 120, 50, -100 );
    scene.add(light);

    const light2 = new DirectionalLight( 0xffffff, 9 );
    light2.position.set( -120, 50, 120 );
    scene.add(light2);

    scene.add(new AmbientLight(0xffffff, 0.5));

    alphabet = new Alphabet();
    scene.background = new Color("#000000");//alphabet.getRgbColor(r.random_choice([ "MP", "LI", "PPB", "PA", "PS", "PP", "BT", "DM","CO"])) );

    scene.add(alphabet.deploy());
    setInterval(changeID, 3000);

    render();
}

function changeID() {
    alphabet.update();
}
var theta = 0;
var radius = 200;

function render() {
    renderer.setAnimationLoop(() => {
        // theta += 0.1;

        // camera.position.x = radius * Math.sin(threeMath.degToRad(theta));
        // camera.position.y = radius * Math.sin(threeMath.degToRad(theta));
        // camera.position.z = radius * Math.cos(threeMath.degToRad(theta));
        // camera.lookAt(scene.position);

        // camera.updateMatrixWorld();

        TWEEN.update();
        renderer.render(scene, camera);

        const time = performance.now();
        
        if (isBeatting) {
            for ( let i = 0, l = list.length; i < l; i ++ ) {
                const object = list[ i ];
                const scale = Math.sin( ( Math.floor( object.position.x ) + time ) * 0.002 ) * 0.3 + 1;
                object.scale.set( scale, scale, scale );
            }
        }
    });
}

window.addEventListener('resize', function() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
})

function genTokenData(projectNum) {
    let data = {};
    let hash = "0x";
    for (var i = 0; i < 64; i++) {
      hash += Math.floor(Math.random() * 16).toString(16);
    }
    data.hash = hash;
    data.tokenId = (projectNum * 1000000 + Math.floor(Math.random() * 1000)).toString();
    return data;
}



